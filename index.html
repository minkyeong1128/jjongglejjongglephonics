<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쫑글쫑글 파닉스</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #ffeb3b;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .main-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .main-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .character {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .main-title {
            font-size: 32px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .main-subtitle {
            font-size: 16px;
            color: #718096;
            margin-bottom: 40px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-button {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 20px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(79, 172, 254, 0.3);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .menu-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(79, 172, 254, 0.4);
        }

        .menu-button.secondary {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            box-shadow: 0 8px 16px rgba(255, 107, 107, 0.3);
        }

        .menu-button.secondary:hover {
            box-shadow: 0 12px 24px rgba(255, 107, 107, 0.4);
        }

        .menu-button.tertiary {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
        }

        .menu-button.tertiary:hover {
            box-shadow: 0 12px 24px rgba(40, 167, 69, 0.4);
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #FFFFFF;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(253, 203, 110, 0.4);
        }

        .hidden {
            display: none !important;
        }

        /* 기존 스타일들을 여기에 포함 */
        .title {
            font-size: 28px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            font-size: 16px;
            color: #718096;
            margin-bottom: 30px;
        }

        .voice-section {
            margin-bottom: 30px;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            font-size: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .mic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(255, 107, 107, 0.4);
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #48bb78, #68d391);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .voice-status {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            min-height: 20px;
        }

        .result-section {
            margin: 30px 0;
        }

        .original-text {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #1565c0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phonics-container {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .phonics-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .syllable-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
            padding: 10px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px dashed #ccc;
        }

        .syllable-label {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding: 5px 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .syllable-phonics {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .phonics-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 70px;
            position: relative;
            border: 2px solid transparent;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .phonics-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            background: #f8f9ff;
        }

        .phonics-item.playing {
            background: linear-gradient(135deg, #fff59d, #ffeb3b);
            transform: scale(1.05);
        }

        .phonics-item.consonant {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
        }

        .phonics-item.vowel {
            border-color: #4299e1;
            background: linear-gradient(135deg, #f0f8ff, #bee3f8);
        }

        .phonics-item.final {
            border-color: #38a169;
            background: linear-gradient(135deg, #f0fff4, #c6f6d5);
        }

        .jamo {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
            font-family: 'Malgun Gothic', Arial, sans-serif;
        }

        .pronunciation {
            font-size: 14px;
            color: #4a5568;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .jamo-type {
            font-size: 10px;
            color: #718096;
            font-style: italic;
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
        }

        .jamo-type.consonant {
            background: #fed7d7;
            color: #c53030;
        }

        .jamo-type.vowel {
            background: #bee3f8;
            color: #2b6cb0;
        }

        .jamo-type.final {
            background: #c6f6d5;
            color: #276749;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .control-button {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 50px;
            color: white;
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 172, 254, 0.4);
        }

        .control-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .speed-slider {
            width: 100px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
        }

        .reset-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 15px;
            color: white;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(253, 203, 110, 0.3);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .reset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(253, 203, 110, 0.4);
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .emoji {
            font-size: 24px;
            margin: 0 5px;
        }

        .demo-section {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }

        .demo-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            color: white;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .demo-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #666;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color.consonant {
            background: #fed7d7;
        }

        .legend-color.vowel {
            background: #bee3f8;
        }

        .legend-color.final {
            background: #c6f6d5;
        }

        /* 게임 스타일 */
        .mode-selection {
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .mode-button {
            background: white;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 12px 20px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mode-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .mode-button.active {
            background: #fff9c4;
            border-color: #ffeb3b;
        }

        .score-board {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #ffffff;
            border-radius: 15px;
            color: black;
            font-weight: normal;
        }

        .question-area {
            margin-bottom: 30px;
        }

        .question-number {
            font-size: 16px;
            color: #718096;
            margin-bottom: 10px;
        }

        .word-image {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border-radius: 15px;
            background: #ffffff;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .word-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .word-image .loading {
            font-size: 2em;
            color: #5a67d8;
        }

        .audio-button {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            color: white;
            font-size: 2em;
            cursor: pointer;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
            transition: all 0.3s ease;
        }

        .audio-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(255,107,107,0.6);
        }

        .choices {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .choice-button {
            background: white;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 1.3em;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-weight: bold;
            margin: 10px;
        }

        .choice-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .choice-button.correct {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .choice-button.incorrect {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .feedback.correct {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .next-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .result-screen {
            display: none;
            text-align: center;
        }

        .final-score {
            font-size: 1.2em;
            color: #000000;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            line-height: 1.5;
        }

        .retry-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 15px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .wrong-answers {
            text-align: left;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #dc3545;
        }

        .wrong-answer-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        /* 자음·모음 학습 스타일 */
        .jamo-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .jamo-tab-button {
            background: white;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 12px 20px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .jamo-tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .jamo-tab-button.active {
            background: #fff9c4;
            border-color: #ffeb3b;
        }

        .jamo-tab-content {
            margin-bottom: 20px;
        }

        .jamo-section-title {
            text-align: center;
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .jamo-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .jamo-card {
            background: white;
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
        }

        .jamo-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .jamo-card.playing {
            transform: scale(1.05);
            border-color: #ffeb3b;
            background: linear-gradient(135deg, #fff59d, #ffeb3b);
        }

        .jamo-card.consonant-card {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
        }

        .jamo-card.vowel-card {
            border-color: #4299e1;
            background: linear-gradient(135deg, #f0f8ff, #bee3f8);
        }

        .jamo-card.final-card {
            border-color: #38a169;
            background: linear-gradient(135deg, #f0fff4, #c6f6d5);
        }

        .jamo-card-jamo {
            font-size: 32px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            font-family: 'Malgun Gothic', Arial, sans-serif;
        }

        .jamo-card-sound {
            font-size: 16px;
            color: #4a5568;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .jamo-card-type {
            font-size: 12px;
            color: #718096;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            font-weight: bold;
        }

        .jamo-card-type.consonant-type {
            background: #fed7d7;
            color: #c53030;
        }

        .jamo-card-type.vowel-type {
            background: #bee3f8;
            color: #2b6cb0;
        }

        .jamo-card-type.final-type {
            background: #c6f6d5;
            color: #276749;
        }

        /* 획순 모달창 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 48px;
            font-weight: bold;
            color: #2d3748;
            margin: 0;
            font-family: 'Malgun Gothic', Arial, sans-serif;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 30px;
            color: #999;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #666;
        }

        .stroke-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }

        .modal-sound {
            font-size: 24px;
            font-weight: bold;
            color: #4a5568;
        }

        .sound-replay-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sound-replay-btn:hover {
            transform: scale(1.1);
        }

        .stroke-canvas-container {
            text-align: center;
            margin-bottom: 20px;
        }

        #strokeCanvas {
            border: 3px solid #ddd;
            border-radius: 15px;
            background: #fafafa;
            cursor: crosshair;
            touch-action: none;
        }

        .stroke-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stroke-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 25px;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .stroke-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
        }

      
        /* 모바일 반응형 */
        @media (max-width: 480px) {
            .main-container {
                padding: 20px;
                margin: 10px;
            }
            
            .main-title {
                font-size: 24px;
            }
            
            .menu-button {
                padding: 15px 20px;
                font-size: 16px;
            }
            
            .mic-button {
                width: 70px;
                height: 70px;
                font-size: 25px;
            }
            
            .phonics-grid {
                gap: 8px;
            }
            
            .phonics-item {
                min-width: 60px;
                padding: 12px;
            }
            
            .controls {
                gap: 10px;
            }
            
            .speed-control {
                padding: 8px 12px;
            }

            .legend {
                gap: 10px;
            }

            .syllable-group {
                margin: 5px;
                padding: 8px;
            }

            .mode-selection {
                gap: 10px;
            }

            .mode-button {
                padding: 12px 18px;
                font-size: 14px;
            }

            /* 자음·모음 학습 모바일 스타일 */
            .jamo-tabs {
                gap: 5px;
            }

            .jamo-tab-button {
                padding: 10px 15px;
                font-size: 12px;
            }

            .jamo-cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: 10px;
                padding: 15px;
            }

            .jamo-card {
                padding: 15px;
            }

            .jamo-card-jamo {
                font-size: 24px;
                margin-bottom: 8px;
            }

            .jamo-card-sound {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .jamo-card-type {
                font-size: 10px;
                padding: 2px 6px;
            }

            /* 획순 모달창 모바일 스타일 */
            .modal-content {
                padding: 20px;
                max-width: 95%;
            }

            .modal-title {
                font-size: 36px;
            }

            .modal-close {
                font-size: 24px;
            }

            #strokeCanvas {
                width: 100%;
                max-width: 280px;
                height: 280px;
            }

            .stroke-controls {
                gap: 8px;
            }

            .stroke-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

                  }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 메인 메뉴 화면 -->
        <div id="mainMenu">
            <div class="character">🎵</div>
            <h1 class="main-title">쫑글쫑글 파닉스</h1>
            <p class="main-subtitle">한글 소리 놀이를 시작해보세요!</p>
            
            <div class="menu-buttons">
                <button class="menu-button tertiary" onclick="showJamoLearning()">
                    📝 자음·모음 배우기
                    <br><small>자음, 모음, 받침을 하나씩 배워보세요</small>
                </button>
                <button class="menu-button" onclick="showSoundAnalysis()">
                    🎤 소리 놀이
                    <br><small>단어를 말하면 자음·모음·받침으로 나누어 들려줘요</small>
                </button>
                <button class="menu-button secondary" onclick="showSoundGame()">
                    🎮 소리 맞추기 게임
                    <br><small>소리를 듣고 맞는 단어를 찾아보세요</small>
                </button>
            </div>
        </div>

        <!-- 소리 분석 화면 -->
        <div id="soundAnalysisScreen" class="hidden">
            <button class="back-button" onclick="showMainMenu()">🔙</button>
            <h1 class="title">🎤 소리 놀이</h1>
            <p class="subtitle">단어를 말하면 자음과 모음, 받침으로 나누어 들려줄게요!</p>

            <div class="demo-section">
                <p style="margin-bottom: 10px; font-size: 14px; color: #666;">예시 단어로 테스트해보세요:</p>
                <button class="demo-button" onclick="testWord('사과')">사과</button>
                <button class="demo-button" onclick="testWord('딸기')">딸기</button>
                <button class="demo-button" onclick="testWord('쭈꾸미')">쭈꾸미</button>
                <button class="demo-button" onclick="testWord('뽀뽀')">뽀뽀</button>
                <button class="demo-button" onclick="testWord('학교')">학교</button>
                <button class="demo-button" onclick="testWord('안녕')">안녕</button>
            </div>

            <div class="voice-section">
                <button class="mic-button" id="micButton">
                    🎤
                </button>
                <div class="voice-status" id="voiceStatus">마이크 버튼을 눌러 단어를 말해보세요</div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>분석중이에요... 잠시만 기다려주세요!</p>
            </div>

            <div class="result-section hidden" id="resultSection">
                <div class="original-text" id="originalText">
                    <span class="emoji">💬</span>
                    여기에 인식된 단어가 나타나요
                    <span class="emoji">💬</span>
                </div>

                <div class="phonics-container">
                    <h3 style="margin-bottom: 15px; color: #f57c00;">자음과 모음, 받침으로 나누어보기</h3>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color consonant"></div>
                            <span>자음</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color vowel"></div>
                            <span>모음</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color final"></div>
                            <span>받침</span>
                        </div>
                    </div>

                    <div class="phonics-grid" id="phonicsGrid">
                        <!-- 음절별 자음/모음/받침 그룹들이 여기에 생성됩니다 -->
                    </div>

                    <div class="controls">
                        <button class="control-button" id="playAllButton">
                            ▶️ 전체 재생
                        </button>
                        
                        <div class="speed-control">
                            <span>🐌</span>
                            <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="2.0" step="0.1" value="0.6">
                            <span>🐰</span>
                            <span id="speedDisplay">0.6x</span>
                        </div>
                    </div>
                </div>

                <button class="reset-button" id="resetButton">
                    🔄 다시하기
                </button>
            </div>
        </div>

        <!-- 게임 화면 -->
        <div id="gameScreen" class="hidden">
            <button class="back-button" onclick="showMainMenu()">🔙</button>
            <h1 class="title">🎮 소리 맞추기 게임</h1>
            <div class="question-area">
                <div class="question-number">단어의 자음·모음·받침 소리를 듣고 맞는 단어를 선택하세요!</div>
                <br><br>
                
                <div class="mode-selection">
                    <button class="mode-button active" id="noBatchimMode" onclick="setMode('noBatchim')">받침 없는 단어</button>
                    <button class="mode-button" id="batchimMode" onclick="setMode('batchim')">받침 있는 단어</button>
                </div>
                
                <div id="gameArea">
                    <div class="score-board">
                        <div>문제: <span id="currentQuestion">1</span> / 10</div>
                        <div>점수: <span id="score">0</span>점</div>
                    </div>
                    
                    <div class="word-image" id="wordImage">
                        <div class="icon icon-apple"></div>
                    </div>

                    <button class="audio-button" id="audioButton" onclick="playAudio()">🔊</button>
                    <div class="choices" id="choices"></div>
                    <div id="feedback" class="feedback hidden"></div>
                    <button id="nextButton" class="next-button hidden" onclick="nextQuestion()">다음 문제</button>
                </div>
            </div>

            <div id="resultScreen" class="result-screen">
                <div class="final-score" id="finalScore"></div>
                <div id="wrongAnswers" class="wrong-answers"></div>
                <button class="retry-button" onclick="restartGame()">다시 시작</button>
            </div>
        </div>

        <!-- 자음·모음 학습 화면 -->
        <div id="jamoLearningScreen" class="hidden">
            <button class="back-button" onclick="showMainMenu()">🔙</button>
            <h1 class="title">📝 자음·모음 배우기</h1>
            <p class="subtitle">각 글자를 클릭하면 소리를 들을 수 있어요!</p>

            <div class="jamo-tabs">
                <button class="jamo-tab-button active" onclick="showJamoTab('consonants')">자음 (ㄱㄴㄷ...)</button>
                <button class="jamo-tab-button" onclick="showJamoTab('vowels')">모음 (ㅏㅓㅗ...)</button>
                <button class="jamo-tab-button" onclick="showJamoTab('finals')">받침 (ㄱㄴㄷ...)</button>
            </div>

            <!-- 자음 학습 -->
            <div id="consonantsTab" class="jamo-tab-content">
                <h3 class="jamo-section-title">자음 (초성)</h3>
                <div class="jamo-cards-grid" id="consonantsGrid">
                    <!-- 자음 카드들이 여기에 생성됩니다 -->
                </div>
            </div>

            <!-- 모음 학습 -->
            <div id="vowelsTab" class="jamo-tab-content hidden">
                <h3 class="jamo-section-title">모음 (중성)</h3>
                <div class="jamo-cards-grid" id="vowelsGrid">
                    <!-- 모음 카드들이 여기에 생성됩니다 -->
                </div>
            </div>

            <!-- 받침 학습 -->
            <div id="finalsTab" class="jamo-tab-content hidden">
                <h3 class="jamo-section-title">받침 (종성)</h3>
                <div class="jamo-cards-grid" id="finalsGrid">
                    <!-- 받침 카드들이 여기에 생성됩니다 -->
                </div>
            </div>
        </div>

        <!-- 획순 모달창 -->
        <div id="strokeOrderModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalJamoTitle" class="modal-title">ㄱ</h3>
                    <button class="modal-close" onclick="closeStrokeModal()">×</button>
                </div>
                <div class="modal-body">
                    <div class="stroke-info">
                        <span id="modalJamoSound" class="modal-sound">그</span>
                        <button class="sound-replay-btn" id="soundReplayBtn">🔊</button>
                    </div>
                    <div class="stroke-canvas-container">
                        <canvas id="strokeCanvas" width="300" height="300"></canvas>
                        <div class="stroke-controls">
                           
                            <button class="stroke-btn" onclick="clearCanvas()">🧹 지우기</button>
                            <button class="stroke-btn" onclick="practiceMode()">✏️ 연습하기</button>
                        </div>
                    </div>
                      </div>
            </div>
        </div>
    </div>

    <script>
let audioPlayback = null;
        // 전역 변수
        let currentApp = null;
        let gameState = {
            currentMode: 'noBatchim',
            currentQuestionIndex: 0,
            score: 0,
            wrongAnswers: [],
            isAnswered: false,
            currentQuestion: null,
            usedWords: [],
            availableWords: []
        };

        // 화면 전환 함수들
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('soundAnalysisScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('jamoLearningScreen').classList.add('hidden');
            
          // 모든 음성 재생 완전히 중단
if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
    // 한 번 더 확실히 중단
    setTimeout(() => {
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }
    }, 100);
}

// 게임의 오디오 재생 중단
if (typeof stopAudioPlayback === 'function') {
    stopAudioPlayback();
}
            
            // 소리 분석 앱 리셋
            if (currentApp && currentApp.resetApp) {
                currentApp.resetApp();
            }
        }

        function showSoundAnalysis() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('soundAnalysisScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('jamoLearningScreen').classList.add('hidden');
            
            // 소리 분석 앱 초기화
            if (!currentApp) {
                currentApp = new HangulPhonicsApp();
            }
        }

        function showSoundGame() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('soundAnalysisScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('jamoLearningScreen').classList.add('hidden');
            
            // 게임 초기화
            initializeGame();
        }

        function showJamoLearning() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('soundAnalysisScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('jamoLearningScreen').classList.remove('hidden');
            
            // 자음·모음 학습 초기화
            initializeJamoLearning();
        }

        // 한글 파닉스 앱 클래스 (기존 코드)
        class HangulPhonicsApp {
            constructor() {
                this.recognition = null;
                this.speechSynthesis = window.speechSynthesis;
                this.currentSpeed = 0.6;
                this.isPlaying = false;
                this.currentData = null;
                this.syllableGroups = [];
                this.playingIndex = -1;
                
                this.initializeElements();
                this.initializeEventListeners();
                this.initializeSpeechRecognition();
                this.checkMicrophonePermission();
                
                this.initializeHangulConstants();
            }

            initializeHangulConstants() {
                this.HANGUL_BASE = 0xAC00;
                this.CONSONANT_COUNT = 19;
                this.VOWEL_COUNT = 21;
                this.FINAL_CONSONANT_COUNT = 28;
                
                this.INITIAL_CONSONANTS = [
                    'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ',
                    'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
                ];
                
                this.VOWELS = [
                    'ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ',
                    'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'
                ];
                
                this.FINAL_CONSONANTS = [
                    '', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ',
                    'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
                ];

                this.INITIAL_PRONUNCIATION_MAP = {
                    'ㄱ': '그', 'ㄲ': '끄', 'ㄴ': '느', 'ㄷ': '드', 'ㄸ': '뜨',
                    'ㄹ': '르', 'ㅁ': '므', 'ㅂ': '브', 'ㅃ': '쁘', 'ㅅ': '스',
                    'ㅆ': '쓰', 'ㅇ': '으', 'ㅈ': '즈', 'ㅉ': '쯔', 'ㅊ': '츠',
                    'ㅋ': '크', 'ㅌ': '트', 'ㅍ': '프', 'ㅎ': '흐'
                };
                
                this.VOWEL_PRONUNCIATION_MAP = {
                    'ㅏ': '아', 'ㅐ': '애', 'ㅑ': '야', 'ㅒ': '얘', 'ㅓ': '어',
                    'ㅔ': '에', 'ㅕ': '여', 'ㅖ': '예', 'ㅗ': '오', 'ㅘ': '와',
                    'ㅙ': '왜', 'ㅚ': '외', 'ㅛ': '요', 'ㅜ': '우', 'ㅝ': '워',
                    'ㅞ': '웨', 'ㅟ': '위', 'ㅠ': '유', 'ㅡ': '으', 'ㅢ': '의', 'ㅣ': '이'
                };
                
                this.FINAL_PRONUNCIATION_MAP = {
                    'ㄱ': '윽', 'ㄲ': '윽', 'ㄳ': '윽', 'ㅋ': '윽',
                    'ㄴ': '은', 'ㄵ': '은', 'ㄶ': '은',
                    'ㄷ': '읏', 'ㅅ': '읏', 'ㅆ': '읏', 'ㅈ': '읏', 
                    'ㅊ': '읏', 'ㅌ': '읏', 'ㅎ': '읏',
                    'ㄹ': '을', 'ㄺ': '윽', 'ㄻ': '음', 'ㄼ': '을', 
                    'ㄽ': '을', 'ㄾ': '을', 'ㄿ': '읍', 'ㅀ': '을',
                    'ㅁ': '음',
                    'ㅂ': '읍', 'ㅄ': '읍', 'ㅍ': '읍',
                    'ㅇ': '응'
                };
            }

            initializeElements() {
                this.micButton = document.getElementById('micButton');
                this.voiceStatus = document.getElementById('voiceStatus');
                this.loading = document.getElementById('loading');
                this.resultSection = document.getElementById('resultSection');
                this.originalText = document.getElementById('originalText');
                this.phonicsGrid = document.getElementById('phonicsGrid');
                this.playAllButton = document.getElementById('playAllButton');
                this.speedSlider = document.getElementById('speedSlider');
                this.speedDisplay = document.getElementById('speedDisplay');
                this.resetButton = document.getElementById('resetButton');
            }

            initializeEventListeners() {
                this.micButton.addEventListener('click', () => this.toggleRecording());
                this.playAllButton.addEventListener('click', () => this.playAll());
                this.speedSlider.addEventListener('input', (e) => this.updateSpeed(e.target.value));
                this.resetButton.addEventListener('click', () => this.resetApp());
            }

            initializeSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || 
                                        window.webkitSpeechRecognition || 
                                        window.mozSpeechRecognition ||
                                        window.msSpeechRecognition;

                if (!SpeechRecognition) {
                    this.voiceStatus.textContent = '죄송해요, 이 브라우저는 음성인식을 지원하지 않아요';
                    this.micButton.disabled = true;
                    return;
                }

                this.recognition = new SpeechRecognition();
                this.recognition.lang = 'ko-KR';
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.maxAlternatives = 1;

                this.recognition.onstart = () => {
                    this.micButton.classList.add('recording');
                    this.voiceStatus.textContent = '듣고 있어요... 단어를 말해보세요!';
                };

                this.recognition.onresult = (event) => {
                    if (event.results && event.results.length > 0) {
                        const text = event.results[0][0].transcript.trim();
                        if (text) {
                            this.processVoiceInput(text);
                        }
                    }
                };

                this.recognition.onerror = (event) => {
                    this.micButton.classList.remove('recording');
                    let errorMessage = '음성인식에 실패했어요. ';
                    switch(event.error) {
                        case 'not-allowed':
                            errorMessage += '마이크 권한을 허용해주세요.';
                            break;
                        case 'no-speech':
                            errorMessage += '음성이 감지되지 않았어요.';
                            break;
                        default:
                            errorMessage += '다시 시도해주세요.';
                    }
                    this.voiceStatus.textContent = errorMessage;
                    setTimeout(() => {
                        if (!this.micButton.classList.contains('recording')) {
                            this.voiceStatus.textContent = '마이크 버튼을 눌러 단어를 말해보세요';
                        }
                    }, 3000);
                };

                this.recognition.onend = () => {
                    this.micButton.classList.remove('recording');
                    if (this.voiceStatus.textContent.includes('듣고 있어요')) {
                        this.voiceStatus.textContent = '마이크 버튼을 눌러 단어를 말해보세요';
                    }
                };
            }

            async checkMicrophonePermission() {
                try {
                    if (navigator.permissions) {
                        const result = await navigator.permissions.query({ name: 'microphone' });
                        if (result.state === 'denied') {
                            this.voiceStatus.textContent = '마이크 권한이 필요해요. 브라우저 설정에서 마이크를 허용해주세요.';
                        }
                    }
                } catch (error) {
                    console.log('권한 확인 중 오류:', error);
                }
            }

            toggleRecording() {
                if (!this.recognition) {
                    alert('음성인식을 사용할 수 없습니다.');
                    return;
                }

                if (this.micButton.classList.contains('recording')) {
                    this.recognition.stop();
                } else {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        this.voiceStatus.textContent = '음성인식을 시작할 수 없어요. 다시 시도해주세요.';
                    }
                }
            }

            processVoiceInput(text) {
                this.voiceStatus.textContent = `"${text}"를 분석중이에요...`;
                this.loading.style.display = 'block';
                setTimeout(() => {
                    this.analyzeHangul(text);
                    this.loading.style.display = 'none';
                }, 500);
            }

             testWord(word) {
                this.voiceStatus.textContent = `"${word}"를 분석중이에요...`;
                this.loading.style.display = 'block';
                setTimeout(() => {
                    this.analyzeHangul(word);
                    this.loading.style.display = 'none';
                }, 500);
            }

            analyzeHangul(text) {
                const hangulOnly = text.replace(/[^가-힣]/g, '');
                
                if (!hangulOnly) {
                    this.voiceStatus.textContent = '한글 단어를 말해주세요!';
                    return;
                }

                this.originalText.innerHTML = `<span class="emoji">💬</span> ${hangulOnly} <span class="emoji">💬</span>`;
                
                const syllableData = [];
                for (let i = 0; i < hangulOnly.length; i++) {
                    const char = hangulOnly[i];
                    const decomposed = this.decompose(char);
                    if (decomposed) {
                        syllableData.push({
                            original: char,
                            ...decomposed
                        });
                    }
                }

                this.currentData = {
                    original: hangulOnly,
                    syllables: syllableData
                };

                this.displayPhonics(syllableData);
                this.resultSection.classList.remove('hidden');
                this.voiceStatus.textContent = '완성! 각 소리를 클릭해보세요 🎵';
            }

            decompose(char) {
                const code = char.charCodeAt(0) - this.HANGUL_BASE;
                if (code < 0 || code > 11171) return null;

                const initialIndex = Math.floor(code / (this.VOWEL_COUNT * this.FINAL_CONSONANT_COUNT));
                const vowelIndex = Math.floor((code % (this.VOWEL_COUNT * this.FINAL_CONSONANT_COUNT)) / this.FINAL_CONSONANT_COUNT);
                const finalIndex = code % this.FINAL_CONSONANT_COUNT;

                return {
                    initial: this.INITIAL_CONSONANTS[initialIndex],
                    vowel: this.VOWELS[vowelIndex],
                    final: finalIndex > 0 ? this.FINAL_CONSONANTS[finalIndex] : null
                };
            }

            displayPhonics(syllableData) {
                this.phonicsGrid.innerHTML = '';
                this.syllableGroups = [];

                syllableData.forEach((syllable) => {
                    const syllableGroup = document.createElement('div');
                    syllableGroup.className = 'syllable-group';
                    
                    const label = document.createElement('div');
                    label.className = 'syllable-label';
                    label.textContent = syllable.original;
                    syllableGroup.appendChild(label);

                    const phonicsContainer = document.createElement('div');
                    phonicsContainer.className = 'syllable-phonics';

                    const phonicsItems = [];

                    if (syllable.initial) {
                        const initialItem = this.createPhonicsItem(
                            syllable.initial, 
                            this.INITIAL_PRONUNCIATION_MAP[syllable.initial] || syllable.initial,
                            'consonant',
                            '자음'
                        );
                        phonicsContainer.appendChild(initialItem);
                        phonicsItems.push(initialItem);
                    }

                    if (syllable.vowel) {
                        const vowelItem = this.createPhonicsItem(
                            syllable.vowel,
                            this.VOWEL_PRONUNCIATION_MAP[syllable.vowel] || syllable.vowel,
                            'vowel',
                            '모음'
                        );
                        phonicsContainer.appendChild(vowelItem);
                        phonicsItems.push(vowelItem);
                    }

                    if (syllable.final) {
                        const finalItem = this.createPhonicsItem(
                            syllable.final,
                            this.FINAL_PRONUNCIATION_MAP[syllable.final] || syllable.final,
                            'final',
                            '받침'
                        );
                        phonicsContainer.appendChild(finalItem);
                        phonicsItems.push(finalItem);
                    }

                    syllableGroup.appendChild(phonicsContainer);
                    this.phonicsGrid.appendChild(syllableGroup);
                    
                    this.syllableGroups.push({
                        element: syllableGroup,
                        items: phonicsItems
                    });
                });
            }

            createPhonicsItem(jamo, pronunciation, type, typeLabel) {
                const item = document.createElement('div');
                item.className = `phonics-item ${type}`;
                
                item.innerHTML = `
                    <div class="jamo">${jamo}</div>
                    <div class="pronunciation">${pronunciation}</div>
                    <div class="jamo-type ${type}">${typeLabel}</div>
                `;

                item.addEventListener('click', () => {
                    this.playSound(pronunciation, item);
                });

                return item;
            }

            playSound(text, element = null) {
                if (this.speechSynthesis.speaking) {
                    this.speechSynthesis.cancel();
                }

                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ko-KR';
                    utterance.rate = this.currentSpeed;
                    utterance.pitch = 1.2;
                    utterance.volume = 1.0;

                    if (element) {
                        element.classList.add('playing');
                        
                        const cleanup = () => {
                            element.classList.remove('playing');
                        };
                        
                        utterance.onend = cleanup;
                        utterance.onerror = cleanup;
                        setTimeout(cleanup, 3000);
                    }

                    this.speechSynthesis.speak(utterance);
                }, 50);
            }

            async playAll() {
                if (this.isPlaying || !this.currentData) return;

                this.isPlaying = true;
                this.playAllButton.disabled = true;
                this.playAllButton.textContent = '🎵 재생중...';

                try {
                    await this.delay(100);
                    await this.playWithDelay(this.currentData.original, null, 800);

                    for (let i = 0; i < this.syllableGroups.length; i++) {
                        if (!this.isPlaying) break;
                        
                        const group = this.syllableGroups[i];
                        await this.playWithDelay(this.currentData.syllables[i].original, null, 600);
                        
                        for (let j = 0; j < group.items.length; j++) {
                            if (!this.isPlaying) break;
                            const item = group.items[j];
                            const pronunciation = item.querySelector('.pronunciation').textContent;
                            await this.playWithDelay(pronunciation, item, 400);
                        }
                        
                        if (i < this.syllableGroups.length - 1) {
                            await this.delay(300);
                        }
                    }

                    if (this.isPlaying) {
                        await this.playWithDelay(this.currentData.original, null, 0);
                    }

                } catch (error) {
                    console.error('재생 중 오류:', error);
                } finally {
                    this.isPlaying = false;
                    this.playAllButton.disabled = false;
                    this.playAllButton.textContent = '▶️ 전체 재생';
                    
                    document.querySelectorAll('.phonics-item.playing').forEach(item => {
                        item.classList.remove('playing');
                    });
                }
            }

            playWithDelay(text, element, delayMs) {
                return new Promise((resolve) => {
                    if (this.speechSynthesis.speaking) {
                        this.speechSynthesis.cancel();
                    }
                    
                    setTimeout(() => {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'ko-KR';
                        utterance.rate = this.currentSpeed;
                        utterance.pitch = 1.2;
                        utterance.volume = 1.0;

                        if (element) {
                            element.classList.add('playing');
                        }

                        let isResolved = false;
                        const resolveOnce = () => {
                            if (!isResolved) {
                                isResolved = true;
                                if (element) {
                                    element.classList.remove('playing');
                                }
                                setTimeout(resolve, delayMs);
                            }
                        };

                        utterance.onend = resolveOnce;
                        utterance.onerror = resolveOnce;

                        const timeoutId = setTimeout(() => {
                            this.speechSynthesis.cancel();
                            resolveOnce();
                        }, Math.max(text.length * 200, 2000));

                        utterance.onstart = () => {
                            clearTimeout(timeoutId);
                        };

                        this.speechSynthesis.speak(utterance);
                    }, 50);
                });
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            updateSpeed(value) {
                this.currentSpeed = parseFloat(value);
                this.speedDisplay.textContent = `${value}x`;
            }

            resetApp() {
                this.isPlaying = false;
                
                if (this.speechSynthesis.speaking) {
                    this.speechSynthesis.cancel();
                }
                
                setTimeout(() => {
                    this.resultSection.classList.add('hidden');
                    this.voiceStatus.textContent = '마이크 버튼을 눌러 단어를 말해보세요';
                    this.currentData = null;
                    this.syllableGroups = [];
                    
                    this.playAllButton.disabled = false;
                    this.playAllButton.textContent = '▶️ 전체 재생';
                    
                    document.querySelectorAll('.phonics-item.playing').forEach(item => {
                        item.classList.remove('playing');
                    });
                }, 100);
            }
        }

        // 전역 함수로 testWord 노출
        function testWord(word) {
            if (currentApp && currentApp.testWord) {
                currentApp.testWord(word);
            }
        }

        // 게임 관련 코드
        const INITIAL_PRONUNCIATION = {
            'ㄱ': '그', 'ㄲ': '끄', 'ㄴ': '느', 'ㄷ': '드', 'ㄸ': '뜨',
            'ㄹ': '르', 'ㅁ': '므', 'ㅂ': '브', 'ㅃ': '쁘', 'ㅅ': '스',
            'ㅆ': '쓰', 'ㅇ': '으', 'ㅈ': '즈', 'ㅉ': '쯔', 'ㅊ': '츠',
            'ㅋ': '크', 'ㅌ': '트', 'ㅍ': '프', 'ㅎ': '흐'
        };
        
        const VOWEL_PRONUNCIATION = {
            'ㅏ': '아', 'ㅐ': '애', 'ㅑ': '야', 'ㅒ': '얘', 'ㅓ': '어',
            'ㅔ': '에', 'ㅕ': '여', 'ㅖ': '예', 'ㅗ': '오', 'ㅘ': '와',
            'ㅙ': '왜', 'ㅚ': '외', 'ㅛ': '요', 'ㅜ': '우', 'ㅝ': '워',
            'ㅞ': '웨', 'ㅟ': '위', 'ㅠ': '유', 'ㅡ': '으', 'ㅢ': '의', 'ㅣ': '이'
        };
        
        const FINAL_PRONUNCIATION = {
            // 기본 받침 7개 (ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ)
            'ㄱ': '윽',  // ㄱ 받침
            'ㄴ': '은',   // ㄴ 받침
            'ㄹ': '을',   // ㄹ 받침
            'ㅁ': '음',   // ㅁ 받침
            'ㅂ': '읍',   // ㅂ 받침
            'ㅅ': '읏',   // ㅅ 받침
            'ㅇ': '응',   // ㅇ 받침
            
            // 나머지 받침들 (게임용으로 유지)
            'ㄲ': '윽', 'ㄳ': '윽', 'ㅋ': '윽',
            'ㄵ': '은', 'ㄶ': '은',
            'ㄷ': '읏', 'ㅆ': '읏', 'ㅈ': '읏', 
            'ㅊ': '읏', 'ㅌ': '읏', 'ㅎ': '읏',
            'ㄺ': '윽', 'ㄻ': '음', 'ㄼ': '을', 
            'ㄽ': '을', 'ㄾ': '을', 'ㄿ': '읍', 'ㅀ': '을',
            'ㅄ': '읍', 'ㅍ': '읍'
        };

        // 한글 자소 분해 함수
        function decomposeHangul(char) {
            const code = char.charCodeAt(0) - 0xAC00;
            if (code < 0 || code > 11171) return null;

            const initial = Math.floor(code / 588);
            const medial = Math.floor((code % 588) / 28);
            const final = code % 28;

            const initials = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
            const medials = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
            const finals = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];

            return {
                initial: initials[initial],
                medial: medials[medial],
                final: finals[final]
            };
        }

        // 단어를 파닉스로 분해 (디버깅 버전)
       function wordToPhonics(word) {
    const phonics = [];
    
    console.log('분해할 단어:', word);
    
    for (let char of word) {
        const decomposed = decomposeHangul(char);
        console.log(`${char} 분해 결과:`, decomposed);
        
        if (decomposed) {
            // 음절별로 묶어서 처리
            const syllablePhonics = [];
            
            // 초성 (자음)
            const initialSound = INITIAL_PRONUNCIATION[decomposed.initial] || decomposed.initial;
            syllablePhonics.push(initialSound);
            
            // 중성 (모음)
            const vowelSound = VOWEL_PRONUNCIATION[decomposed.medial] || decomposed.medial;
            syllablePhonics.push(vowelSound);
            
            // 종성 (받침) - 있는 경우에만
            if (decomposed.final) {
                const finalSound = FINAL_PRONUNCIATION[decomposed.final] || decomposed.final;
                syllablePhonics.push(finalSound);
            }
            
            // 음절 단위로 phonics 배열에 추가
            phonics.push(...syllablePhonics);
        }
    }
    
    // 연속된 동일한 소리 제거
    const uniquePhonics = [];
    for (let i = 0; i < phonics.length; i++) {
        if (i === 0 || phonics[i] !== phonics[i-1]) {
            uniquePhonics.push(phonics[i]);
        }
    }
    
    console.log('중복 제거 후 파닉스:', uniquePhonics);
    return uniquePhonics;
}

        // 단어 데이터
        const noBatchimWordsWithIcons = [
            '나비', '여우', '개구리', '두더지', '하마', '메뚜기', '토끼', '코끼리', '사자', '돼지', '고래', '개미', '까마귀',
            '사과', '바나나', '포도', '토마토', '체리', '우유', '치즈', '과자', '케이크', '고기',
            '나무', '해', '구름', '비', '무지개', '바다', '모래', '해파리',
            '모자', '시계', '카메라', '비누', '의자', '수세미', '자', '가위',
            '버스', '기차', '배', '오토바이',
            '오리', '거위', '소', '크레파스', '머리', '마트'
        ];

        const batchimWordsWithIcons = [
            '강아지', '고양이', '호랑이', '물고기', '상어', '문어', '비둘기', '독수리', '부엉이', 
            '까마귀', '닭', '말', '양', '염소', '기린', '원숭이', '팬더', '곰', '늑대', '사슴', 
            '다람쥐', '고슴도치', '박쥐', '펭귄', '캥거루', '참새',
            '딸기', '사탕', '밥', '국', '달걀', '빵', '떡', '아이스크림', '초콜릿','콩', '쌀', '감자', '당근',
            '바람', '천둥', '번개', '눈', '산', '강', '꽃', '잎',
            '신발', '열쇠', '거울', '가방', '책', '연필', '테이프', '공책', 
            '펜', '컴퓨터', '핸드폰', '안경', '양말', '장갑','전화', '우산', '새싹', '침대',
            '자전거', '택시', '트럭', '자동차', '비행기', '헬리콥터',
            '빨강', '노랑', '파랑', '초록', '하양',
            '얼굴', '눈', '코', '입', '귀', '손', '발',
            '집', '학교', '병원'
        ];

        // 단어별 이모지 매핑
        const wordEmojiMap = {
            '나비': '🦋', '여우': '🦊', '개구리': '🐸', '두더지': '🦫', 
            '하마': '🦛', '메뚜기': '🦗', '토끼': '🐰', '코끼리': '🐘', 
            '사자': '🦁', '돼지': '🐷', '고래': '🐋', 
            '개미': '🐜', '소': '🐄', '까마귀': '🐦‍⬛', 
            '사과': '🍎', '바나나': '🍌', '포도': '🍇', '토마토': '🍅',
            '체리': '🍒', '우유': '🥛', '치즈': '🧀',
            '과자': '🍪', '케이크': '🎂', '고기': '🥩',
            '나무': '🌳', '해': '☀️', '구름': '☁️', '비': '🌧️',
            '무지개': '🌈', '바다': '🌊', '모래': '🏖️', '해파리': '🪼', 
            '모자': '👒', '시계': '⏰', '카메라': '📷', '비누': '🧼',
            '의자': '🪑', '수세미': '🧽', '자': '📏', '가위': '✂️',
            '버스': '🚌', '기차': '🚂', '배': '🚢', '오토바이': '🏍️',
            '오리': '🦆', '거위': '🦢', '크레파스': '🖍️', '머리': '💇', '마트': '🏪', 
            '강아지': '🐶', '고양이': '🐱', '호랑이': '🐅', '물고기': '🐟', 
            '상어': '🦈', '문어': '🐙', '비둘기': '🕊️', '독수리': '🦅',
            '부엉이': '🦉', '참새': '🐦', '닭': '🐓', 
            '말': '🐴', '양': '🐑', '염소': '🐐', '기린': '🦒', 
            '원숭이': '🐒', '팬더': '🐼', '곰': '🐻', '늑대': '🐺', 
            '사슴': '🦌', '다람쥐': '🐿️', '고슴도치': '🦔', '박쥐': '🦇', 
            '펭귄': '🐧', '캥거루': '🦘',
            '딸기': '🍓', '사탕': '🍬', '밥': '🍚', '국': '🍲', 
            '달걀': '🥚', '빵': '🍞', 
            '떡': '🍡', '아이스크림': '🍦', '초콜릿': '🍫', 
            '콩': '🫘', '쌀': '🌾', '감자': '🥔', '당근': '🥕',
            '바람': '💨', '천둥': '⛈️', '번개': '⚡', 
            '눈': '❄️', '산': '⛰️', '강': '🏞️', 
            '꽃': '🌸', '잎': '🍃', 
            '신발': '👟', '열쇠': '🔑', '거울': '🪞',
            '가방': '🎒', '책': '📚', 
            '연필': '✏️', '공책': '📓', '펜': '🖊️', 
            '컴퓨터': '💻', '핸드폰': '📱', '안경': '👓', 
            '양말': '🧦', '장갑': '🧤','전화': '☎️', 
            '우산': '☂️', '새싹': '🌱', '침대': '🛏️',
            '자전거': '🚲', '택시': '🚕', '트럭': '🚚', '자동차': '🚗', 
            '비행기': '✈️', '헬리콥터': '🚁',
            '빨강': '🔴', '노랑': '🟡', '파랑': '🔵', '초록': '🟢', '하양': '⚪',
            '얼굴': '😊', '눈': '👁️', '코': '👃', '입': '👄', 
            '귀': '👂', '손': '✋', '발': '🦶', 
            '집': '🏠', '학교': '🏫', '병원': '🏥'
        };

        // 게임 관련 함수들
        function loadImageForWord(word) {
            const wordImageContainer = document.getElementById('wordImage');
            const emoji = wordEmojiMap[word] || '❓';
            wordImageContainer.innerHTML = `<div style="font-size: 4em; color: #5a67d8; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">${emoji}</div>`;
        }

        function playCorrectSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('오디오 재생 실패:', error);
            }
        }

        function playIncorrectSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(250, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (error) {
                console.log('오디오 재생 실패:', error);
            }
        }

        function generateRandomChoices(correctAnswer, wordPool) {
            const choices = [correctAnswer];
            const correctSyllableCount = correctAnswer.length;
            
            const availableWords = wordPool.filter(word => 
                word !== correctAnswer && word.length === correctSyllableCount
            );
            
            const finalWordPool = availableWords.length >= 2 ? availableWords : 
                                 wordPool.filter(word => word !== correctAnswer);
            
            while (choices.length < 3) {
                const randomWord = finalWordPool[Math.floor(Math.random() * finalWordPool.length)];
                if (!choices.includes(randomWord)) {
                    choices.push(randomWord);
                }
            }
            
            return choices.sort(() => Math.random() - 0.5);
        }

        function generateNewQuestion() {
            if (gameState.availableWords.length === 0) {
                const wordPool = gameState.currentMode === 'noBatchim' ? noBatchimWordsWithIcons : batchimWordsWithIcons;
                gameState.availableWords = [...wordPool];
            }
            
            const randomIndex = Math.floor(Math.random() * gameState.availableWords.length);
            const correctWord = gameState.availableWords.splice(randomIndex, 1)[0];
            
            gameState.usedWords.push(correctWord);
            
            const wordPool = gameState.currentMode === 'noBatchim' ? noBatchimWordsWithIcons : batchimWordsWithIcons;
            const choices = generateRandomChoices(correctWord, wordPool);
            
            return {
                word: correctWord,
                choices: choices,
                correct: choices.indexOf(correctWord)
            };
        }

        function setMode(mode) {
            gameState.currentMode = mode;
            document.getElementById('noBatchimMode').classList.toggle('active', mode === 'noBatchim');
            document.getElementById('batchimMode').classList.toggle('active', mode === 'batchim');

            gameState.usedWords = [];
            gameState.availableWords = [];

            restartGame();
        }

        function playAudio() {
    if (!gameState.currentQuestion) return;

    // 기존 재생 중단
    stopAudioPlayback();

    const phonics = wordToPhonics(gameState.currentQuestion.word);
    console.log('재생할 파닉스:', phonics);
    
    const uniquePhonics = [];
    for (let i = 0; i < phonics.length; i++) {
        if (i === 0 || phonics[i] !== phonics[i-1]) {
            uniquePhonics.push(phonics[i]);
        }
    }
    
    console.log('중복 제거 후:', uniquePhonics);
    
    let index = 0;
    let isStopped = false;

    function playNext() {
        if (index >= uniquePhonics.length || isStopped) return;

        const utterance = new SpeechSynthesisUtterance(uniquePhonics[index]);
        utterance.lang = 'ko-KR';
        utterance.rate = 0.5;
        utterance.volume = 1.0;
        utterance.pitch = 1.2;

        utterance.onend = function() {
            index++;
            if (index < uniquePhonics.length && !isStopped) {
                setTimeout(playNext, 400);
            }
        };

        utterance.onerror = function() {
            console.log('음성 재생 오류');
            index++;
            if (index < uniquePhonics.length && !isStopped) {
                setTimeout(playNext, 400);
            }
        };

        window.speechSynthesis.speak(utterance);
    }

    audioPlayback = {
        stop: function() {
            isStopped = true;
            window.speechSynthesis.cancel();
        }
    };

    setTimeout(playNext, 100);
}
function stopAudioPlayback() {
    if (audioPlayback && audioPlayback.stop) {
        audioPlayback.stop();
        audioPlayback = null;
    }
    window.speechSynthesis.cancel();
}

        function displayQuestion() {
            gameState.currentQuestion = generateNewQuestion();

            document.getElementById('currentQuestion').textContent = gameState.currentQuestionIndex + 1;
            
            loadImageForWord(gameState.currentQuestion.word);

            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';

            gameState.currentQuestion.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice;
                button.onclick = () => selectAnswer(index);
                choicesContainer.appendChild(button);
            });

            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('nextButton').classList.add('hidden');
            gameState.isAnswered = false;
        }

        function selectAnswer(selectedIndex) {
            if (gameState.isAnswered) return;
            
        // 파닉스 재생 완전히 중단
stopAudioPlayback();

// 짧은 대기 후 완전히 중단되었는지 확인
setTimeout(() => {
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
    }
}, 50);

// 선택한 보기의 소리 재생
setTimeout(() => {
    const selectedWord = gameState.currentQuestion.choices[selectedIndex];
    const utterance = new SpeechSynthesisUtterance(selectedWord);
    utterance.lang = 'ko-KR';
    utterance.rate = 0.8;
    utterance.volume = 1.0;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
}, 200);
            
            gameState.isAnswered = true;

            const correctIndex = gameState.currentQuestion.choices.indexOf(gameState.currentQuestion.word);
            const buttons = document.querySelectorAll('.choice-button');
            const feedback = document.getElementById('feedback');

            buttons.forEach(btn => btn.style.pointerEvents = 'none');

            if (selectedIndex === correctIndex) {
                gameState.score++;
                document.getElementById('score').textContent = gameState.score;

                buttons[selectedIndex].classList.add('correct');
                feedback.className = 'feedback correct';
                feedback.innerHTML = `<strong>정답입니다! 🎉</strong><br>정답: ${gameState.currentQuestion.word}`;
                feedback.classList.remove('hidden');
                
                playCorrectSound();
            } else {
                buttons.forEach((btn, index) => {
                    if (index === correctIndex) {
                        btn.classList.add('correct');
                    } else {
                        btn.classList.add('incorrect');
                    }
                });

                gameState.wrongAnswers.push({
                    question: gameState.currentQuestionIndex + 1,
                    word: gameState.currentQuestion.word,
                    userAnswer: gameState.currentQuestion.choices[selectedIndex],
                    correctAnswer: gameState.currentQuestion.word
                });

                feedback.className = 'feedback incorrect';
                feedback.innerHTML = `<strong>틀렸습니다! 😅</strong><br>정답: ${gameState.currentQuestion.word}`;
                feedback.classList.remove('hidden');
                
                playIncorrectSound();
            }

            document.getElementById('nextButton').classList.remove('hidden');
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            
            if (gameState.currentQuestionIndex >= 10) {
                showResult();
            } else {
                displayQuestion();
            }
        }

        function showResult() {
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';

            const totalQuestions = 10;
            const correctAnswers = gameState.score;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            let message = '';
            if (percentage === 100) {
                message = '🎉 완벽해요! 모든 문제를 맞췄어요! 🎉';
            } else if (percentage >= 80) {
                message = '🌟 훌륭해요! 정말 잘했어요! 🌟';
            } else if (percentage >= 60) {
                message = '👍 좋아요! 조금만 더 연습하면 더 잘할 수 있어요! 👍';
            } else {
                message = '💪 괜찮아요! 다시 도전해보세요! 💪';
            }
            
            document.getElementById('finalScore').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 1.1em; margin-bottom: 10px;">
                        총 <span style="color: #ff6b6b;">${totalQuestions}</span>문제 중 
                        <span style="color: #ff6b6b;">${correctAnswers}</span>문제 정답!
                    </div>
                    <div style="font-size: 1.5em; color: #ff6b6b;">
                        최종 점수: ${gameState.score}점
                    </div>
                    <div style="font-size: 1.1em; margin-top: 20px; color: #000000;">
                        ${message}
                    </div>
                </div>
            `;

            const wrongAnswersContainer = document.getElementById('wrongAnswers');
            wrongAnswersContainer.style.display = 'none';
        }

        function restartGame() {
            gameState.currentQuestionIndex = 0;
            gameState.score = 0;
            gameState.wrongAnswers = [];
            gameState.isAnswered = false;
            gameState.currentQuestion = null;
            gameState.usedWords = [];
            gameState.availableWords = [];

            document.getElementById('score').textContent = '0';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('resultScreen').style.display = 'none';

            displayQuestion();
        }

        function initializeGame() {
            displayQuestion();
            setTimeout(playAudio, 1000);
        }

        // 앱 시작 시 메인 메뉴 표시
        window.onload = function() {
            showMainMenu();
        };

       // 획순 데이터 정의

// 자음·모음 학습 관련 함수들
        function initializeJamoLearning() {
            createConsonantCards();
            createVowelCards();
            createFinalCards();
            showJamoTab('consonants'); // 기본적으로 자음 탭 표시
        }

        function showJamoTab(tabName) {
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.jamo-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 모든 탭 컨텐츠 숨기기
            document.querySelectorAll('.jamo-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // 선택된 탭 활성화
            if (tabName === 'consonants') {
                document.querySelector('.jamo-tab-button:nth-child(1)').classList.add('active');
                document.getElementById('consonantsTab').classList.remove('hidden');
            } else if (tabName === 'vowels') {
                document.querySelector('.jamo-tab-button:nth-child(2)').classList.add('active');
                document.getElementById('vowelsTab').classList.remove('hidden');
            } else if (tabName === 'finals') {
                document.querySelector('.jamo-tab-button:nth-child(3)').classList.add('active');
                document.getElementById('finalsTab').classList.remove('hidden');
            }
        }

        function createConsonantCards() {
            // 기본 자음 (ㄱ-ㅎ) + 쌍자음 순서로 배열
            const consonants = [
                // 기본 자음
                'ㄱ', 'ㄴ', 'ㄷ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅅ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ',
                // 쌍자음
                'ㄲ', 'ㄸ', 'ㅃ', 'ㅆ', 'ㅉ'
            ];
            const grid = document.getElementById('consonantsGrid');
            grid.innerHTML = '';

            consonants.forEach(consonant => {
                const sound = INITIAL_PRONUNCIATION[consonant] || consonant;
                const card = createJamoCard(consonant, sound, 'consonant', '자음');
                grid.appendChild(card);
            });
        }

        function createVowelCards() {
            // 기본 모음 (ㅏ-ㅣ) + 이중모음 순서로 배열
            const vowels = [
                // 기본 모음
                'ㅏ', 'ㅑ', 'ㅓ', 'ㅕ', 'ㅗ', 'ㅛ', 'ㅜ', 'ㅠ', 'ㅡ', 'ㅣ',
                // 이중모음
                'ㅐ', 'ㅒ', 'ㅔ', 'ㅖ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅢ'
            ];
            const grid = document.getElementById('vowelsGrid');
            grid.innerHTML = '';

            vowels.forEach(vowel => {
                const sound = VOWEL_PRONUNCIATION[vowel] || vowel;
                const card = createJamoCard(vowel, sound, 'vowel', '모음');
                grid.appendChild(card);
            });
        }

        function createFinalCards() {
            // 기본 받침 7개 (ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ)
            const finals = ['ㄱ', 'ㄴ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅅ', 'ㅇ'];
            const grid = document.getElementById('finalsGrid');
            grid.innerHTML = '';

            finals.forEach(final => {
                const sound = FINAL_PRONUNCIATION[final] || final;
                const card = createJamoCard(final, sound, 'final', '받침');
                grid.appendChild(card);
            });
        }

        function createJamoCard(jamo, sound, type, typeLabel) {
            const card = document.createElement('div');
            card.className = `jamo-card ${type}-card`;
            
            card.innerHTML = `
                <div class="jamo-card-jamo">${jamo}</div>
                <div class="jamo-card-sound">${sound}</div>
                <div class="jamo-card-type ${type}-type">${typeLabel}</div>
            `;

            card.addEventListener('click', () => {
                playJamoSound(sound, card);
                // 획순 모달창 열기
                setTimeout(() => {
                    openStrokeModal(jamo, sound, type);
                }, 500);
            });

            return card;
        }

        // 획순 모달창 관련 변수들
        let currentJamo = '';
        let currentSound = '';
        let currentType = '';
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let isPracticeMode = false;

       function openStrokeModal(jamo, sound, type) {
    console.log('모달 열기:', jamo, sound, type);
    currentJamo = jamo;
    currentSound = sound;
    currentType = type;

    document.getElementById('modalJamoTitle').textContent = jamo;
    document.getElementById('modalJamoSound').textContent = sound;
    document.getElementById('strokeOrderModal').classList.remove('hidden');

    // 소리 재생 버튼에 이벤트 리스너 추가
    const soundReplayBtn = document.getElementById('soundReplayBtn');
    soundReplayBtn.removeEventListener('click', handleSoundReplay);
    soundReplayBtn.addEventListener('click', handleSoundReplay);

    // 캔버스 초기화
    canvas = document.getElementById('strokeCanvas');
    ctx = canvas.getContext('2d');
    setupCanvas();
    
    // 기본으로 연습하기 모드 실행
    setTimeout(() => {
        practiceMode();
    }, 300);
    
    console.log('모달 설정 완료, currentSound:', currentSound);
}

        // 소리 재생 이벤트 핸들러
        function handleSoundReplay(event) {
            event.preventDefault();
            console.log('소리 재생 버튼 클릭됨, currentSound:', currentSound);
            try {
                if (currentSound) {
                    playModalSound(currentSound);
                } else {
                    console.error('currentSound가 설정되지 않음');
                }
            } catch (error) {
                console.error('소리 재생 중 오류:', error);
            }
        }

        // 모달창용 소리 재생 함수
        function playModalSound(sound) {
            console.log('playModalSound 호출:', sound);
            
            // 기존 재생 중단
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }

            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(sound);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.8;
                utterance.pitch = 1.2;
                utterance.volume = 1.0;

                utterance.onend = () => {
                    console.log('모달 소리 재생 완료:', sound);
                };

                utterance.onerror = (e) => {
                    console.error('모달 소리 재생 오류:', e);
                };

                console.log('모달 소리 재생 시작:', sound);
                window.speechSynthesis.speak(utterance);
            }, 100);
        }

        function closeStrokeModal() {
            document.getElementById('strokeOrderModal').classList.add('hidden');
            if (canvas) {
                clearCanvas();
            }
        }

        function setupCanvas() {
            if (!canvas || !ctx) return;

            // 캔버스 설정
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 8;
            
            // 터치 이벤트 (모바일)
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            // 마우스 이벤트 (데스크탑)
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

       function clearCanvas() {
    if (!ctx) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawGuideLines();
    
    // 연습 모드일 때는 연한 글씨 가이드도 다시 그리기
    if (isPracticeMode) {
        drawGuideCharacter();
    }
}

        function drawGuideLines() {
            if (!ctx) return;
            
            ctx.save();
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // 중앙 십자선
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
            
            ctx.restore();
        }

       
        function practiceMode() {
            clearCanvas();
            isPracticeMode = true;
            
            // 연한 글자 가이드 그리기
            drawGuideCharacter();
        }

        function drawGuideCharacter() {
            if (!ctx) return;
            
            ctx.save();
            ctx.font = '200px "Malgun Gothic", Arial, sans-serif';
            ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(currentJamo, canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

      
        function startDrawing(e) {
            if (!isPracticeMode) return;
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            ctx.strokeStyle = '#4facfe';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing || !isPracticeMode) return;
            
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // 디버깅을 위한 간단한 테스트 함수
        function testModalSound() {
            console.log('테스트 소리 재생');
            playModalSound('테스트');
        }

        function replayModalSound() {
            playJamoSound(currentSound);
        }

        function playJamoSound(sound, cardElement) {
            // 기존 재생 중단
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }

            // 모든 카드의 playing 클래스 제거
            document.querySelectorAll('.jamo-card.playing').forEach(card => {
                card.classList.remove('playing');
            });

            // 현재 카드에 playing 클래스 추가
            cardElement.classList.add('playing');

            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(sound);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.8;
                utterance.pitch = 1.2;
                utterance.volume = 1.0;

                const cleanup = () => {
                    cardElement.classList.remove('playing');
                };

                utterance.onend = cleanup;
                utterance.onerror = cleanup;

                // 타임아웃 안전장치
                setTimeout(cleanup, 2000);

                window.speechSynthesis.speak(utterance);
            }, 100);
        }
    </script>
</body>
</html>
